# Sub-Task 4.1: Finalize Pydantic Models for All Protocol v2 Fields

**Objective:** Consolidate and finalize the Pydantic models (`SourceDescription`, `SinkDescription`, `RTPConfig`, `WebRTCConfig`, etc.) in `src/screamrouter_types/configuration.py` to include all fields required by Protocol v2, ensuring consistency with previous sub-task definitions and the overall `protocol_spec_v2.md`.

**Parent Task:** [Python Configuration System Updates for Protocol v2](../task_04_python_config_updates.md)
**Related Sub-Tasks:**
*   [Sub-Task 1.7: Update Configuration for RTP Parameters](./../task_01_rtp_library_integration/subtask_1.7_update_configuration_for_rtp.md)
*   [Sub-Task 2.6: Update Configuration for WebRTC Parameters](./../task_02_webrtc_library_integration/subtask_2.6_update_configuration_for_webrtc.md)

## Key Steps & Considerations:

1.  **Review `protocol_spec_v2.md#6-configuration-data-model-changes`:**
    *   This section of the specification is the primary source for required fields.
    *   Ensure all specified fields are present in the Pydantic models with correct types and descriptions.

2.  **Consolidate `BaseDescription` (if applicable) or `SourceDescription`/`SinkDescription`:**
    *   **`uuid: Optional[str] = Field(default=None, ...)`**: Universally Unique Identifier.
    *   **`protocol_type: Literal["scream", "rtp", "webrtc", "sip"] = Field(default="scream", ...)`**: Primary communication protocol.
        *   "sip" implies the device is managed via SIP, and its actual media protocol (RTP/WebRTC) is determined by SDP or further configuration.
    *   **`sip_contact_uri: Optional[str] = Field(default=None, ...)`**: SIP Contact URI of a registered device.
    *   **`enabled: bool = True`**: Existing field, ensure it interacts correctly with SIP online/offline status.
    *   Other existing fields (`name`, `ip`, `port`, `volume`, `eq_config`, etc.) should be reviewed for continued relevance or modification. For SIP-managed devices, `ip` and `port` might become informational (derived from SIP Contact) rather than directly configurable for media.

3.  **Finalize `RTPConfig(BaseModel)`:**
    *   `destination_port: Optional[int]`: For RTP sinks.
    *   `source_listening_port: Optional[int]`: For RTP sources.
    *   `payload_type_pcm: int = Field(default=127, ...)`
    *   `payload_type_mp3: int = Field(default=14, ...)`
    *   `codec_preferences: List[str] = Field(default_factory=list, description="Ordered list of preferred codecs, e.g., ['L16/48000/2', 'MP3/192k']")`
    *   `srtp_enabled: bool = Field(default=False, description="Enable SRTP for this RTP stream.")` (Future use)
    *   `srtp_key: Optional[str] = Field(default=None, description="SRTP master key (e.g., in SDES format).")` (Future use)
    *   Consider if SSRC should be configurable here or always auto-generated/discovered. The spec implies SSRC is discovered or auto-generated by oRTP/libdatachannel.

4.  **Finalize `WebRTCConfig(BaseModel)`:**
    *   `stun_servers: List[str] = Field(default_factory=lambda: ["stun:stun.l.google.com:19302"], ...)`
    *   `turn_servers: List[TURNServerConfig] = Field(default_factory=list, ...)`
    *   `TURNServerConfig(BaseModel)`:
        *   `urls: List[str] = Field(default_factory=list)`
        *   `username: Optional[str] = None`
        *   `credential: Optional[str] = None`

5.  **Add Nested Configs to `SourceDescription` and `SinkDescription`:**
    ```python
    # In src/screamrouter_types/configuration.py

    # class SourceDescription(BaseDescription): # Or inherits directly from BaseModel
    #     # ... other source-specific fields ...
    #     rtp_config: Optional[RTPConfig] = Field(default_factory=RTPConfig)
    #     # WebRTC typically isn't a source in this model, but could be if bi-directional data channels are used.
    #     webrtc_config: Optional[WebRTCConfig] = Field(default=None) # Or default_factory=WebRTCConfig if sources can be WebRTC

    # class SinkDescription(BaseDescription): # Or inherits directly from BaseModel
    #     # ... other sink-specific fields ...
    #     rtp_config: Optional[RTPConfig] = Field(default_factory=RTPConfig)
    #     webrtc_config: Optional[WebRTCConfig] = Field(default_factory=WebRTCConfig)
    ```
    *   Ensure `default_factory` is used for nested models to provide default instances.

6.  **Review Field Nullability and Defaults:**
    *   Fields that are only relevant for specific `protocol_type` values should be `Optional` and default to `None` or an empty/default state.
    *   Pydantic's `default_factory` is excellent for complex defaults like empty lists or default model instances.

7.  **Add Descriptions:**
    *   Provide clear `description` strings for all new and modified fields. This helps with documentation generation and API discoverability (e.g., FastAPI/Swagger UI).

## Code Alterations:

*   **File:** `src/screamrouter_types/configuration.py`
    *   Thoroughly review and update all relevant Pydantic models (`BaseDescription`, `SourceDescription`, `SinkDescription`, `RTPConfig`, `WebRTCConfig`, `TURNServerConfig`) to match the consolidated requirements.
    *   Ensure all `Literal` types for `protocol_type` include "scream", "rtp", "webrtc", and "sip".

## Recommendations:

*   **Single Source of Truth:** The `protocol_spec_v2.md` should be the definitive guide for these models. Any discrepancies found during implementation should lead to updating the spec or the models to align.
*   **Backward Compatibility:** Pydantic handles new optional fields with defaults well when loading older configurations. Ensure this behavior is maintained.
*   **Clarity:** Use descriptive field names and comprehensive `description` attributes.

## Acceptance Criteria:

*   All Pydantic models in `src/screamrouter_types/configuration.py` accurately reflect the fields defined in `protocol_spec_v2.md#6-configuration-data-model-changes` and previous sub-task definitions.
*   Fields include `uuid`, `protocol_type` (with all four values: "scream", "rtp", "webrtc", "sip"), `sip_contact_uri`.
*   Nested `RTPConfig` and `WebRTCConfig` (with `TURNServerConfig`) are correctly defined and integrated.
*   Appropriate use of `Optional`, `Field(default=...)`, and `Field(default_factory=...)` ensures robust default values and handling of missing fields in older configs.
*   All new/modified fields have clear `description` attributes.
