let visualPlaying=!1,visualAlreadyConnected=!1,isFullscreen=!1,visualizer=null,audioContext=null,delayedAudible=null,presets={},presetKeys=[],presetIndexHist=[],presetIndex=0,cycleInterval=0,presetCycleLength=15e3,presetRandom=!0,canvas=null;function initVisualizer(){canvas=document.getElementById("canvas"),canvas&&(canvas.addEventListener("click",toggleFullscreen),document.addEventListener("keydown",handleKeyDown))}function startVisualizer(e){const t=document.getElementById("audio_visualizer");if(t.pause(),t.src=`/stream/${e}/`,t.play(),visualPlaying=!0,!visualAlreadyConnected){initPlayer();const e=audioContext.createMediaElementSource(t);visualAlreadyConnected=!0,e.disconnect(audioContext),startRenderer(),connectToAudioAnalyzer(e)}document.getElementById("mainWrapper").style.display="inherit"}function stopVisualizer(){document.getElementById("audio_visualizer").pause(),document.getElementById("mainWrapper").style.display="none",visualPlaying=!1}function toggleFullscreen(){const e=document.getElementById("mainWrapper"),t=document.getElementById("presetControls");isFullscreen?(document.exitFullscreen&&document.fullscreenElement&&document.exitFullscreen(),e.style.position="relative",e.style.width="100%",e.style.height="auto",e.style.zIndex="auto",t.style.display="block"):(e.requestFullscreen&&e.requestFullscreen(),e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.zIndex="9999",t.style.display="none"),isFullscreen=!isFullscreen}function connectToAudioAnalyzer(e){delayedAudible&&delayedAudible.disconnect(),delayedAudible=audioContext.createDelay(),delayedAudible.delayTime.value=.26,e.connect(delayedAudible),visualizer.connectAudio(delayedAudible)}function startRenderer(){requestAnimationFrame(startRenderer),visualizer.render()}function nextPreset(e=5.7){presetIndexHist.push(presetIndex),presetIndex=presetRandom?Math.floor(Math.random()*presetKeys.length):(presetIndex+1)%presetKeys.length,visualizer.loadPreset(presets[presetKeys[presetIndex]],e),document.getElementById("presetSelect").value=presetIndex}function prevPreset(e=5.7){presetIndex=presetIndexHist.length>0?presetIndexHist.pop():(presetIndex-1+presetKeys.length)%presetKeys.length,visualizer.loadPreset(presets[presetKeys[presetIndex]],e),document.getElementById("presetSelect").value=presetIndex}function randomPreset(e=5.7){presetIndexHist.push(presetIndex),presetIndex=Math.floor(Math.random()*presetKeys.length),visualizer.loadPreset(presets[presetKeys[presetIndex]],e),document.getElementById("presetSelect").value=presetIndex}function handleKeyDown(e){switch(e.key.toLowerCase()){case"f":toggleFullscreen();break;case"n":nextPreset();break;case"l":prevPreset();break;case"h":randomPreset()}}function initPlayer(){audioContext=new AudioContext,presets={},window.butterchurnPresets&&Object.assign(presets,butterchurnPresets.getPresets()),window.butterchurnPresetsExtra&&Object.assign(presets,butterchurnPresetsExtra.getPresets()),presets=_(presets).toPairs().sortBy((([e])=>e.toLowerCase())).fromPairs().value(),presetKeys=_.keys(presets),presetIndex=Math.floor(Math.random()*presetKeys.length);const e=document.getElementById("presetSelect");for(let t=0;t<presetKeys.length;t++){const s=document.createElement("option");s.innerHTML=presetKeys[t].substring(0,60)+(presetKeys[t].length>60?"...":""),s.value=t,e.appendChild(s)}canvas=document.getElementById("canvas"),visualizer=butterchurn.default.createVisualizer(audioContext,canvas,{width:3840,height:2160,pixelRatio:window.devicePixelRatio||1,textureRatio:1}),nextPreset(0),cycleInterval=setInterval((()=>nextPreset(2.7)),presetCycleLength)}window.startVisualizer=startVisualizer,window.stopVisualizer=stopVisualizer,window.toggleFullscreen=toggleFullscreen,document.addEventListener("DOMContentLoaded",initVisualizer);